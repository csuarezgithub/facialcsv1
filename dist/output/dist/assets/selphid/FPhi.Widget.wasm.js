if(!FPhi)var FPhi={};function arrayBufferToBase64(e){for(var t="",i=new Uint8Array(e),a=i.byteLength,s=0;s<a;s++)t+=String.fromCharCode(i[s]);return window.btoa(t)}if(FPhi.SelphID||(FPhi.SelphID={}),FPhi.SelphID.Mode={Front:0,Back:1,Full:2},FPhi.SelphID.CaptureSensibility={Low:0,Normal:1,High:2,Auto:3},FPhi.SelphID.TrackStatus={ChangeState:0,Tap:1},FPhi.SelphID.ModeStr=["Front","Back","Full"],FPhi.SelphID.CaptureSensibilityStr=["Low","Normal","High","Auto"],FPhi.ExceptionType={CameraError:0,ExtractorError:1,ControlNotInitializedError:2,ImageCropResizeError:3,UnexpectedCaptureError:4},FPhi.SelphID.Widget=function(e){if(this.version="1.0.0.29",console.log("FPhi.SelphID.Widget version: "+this.version),this.cm=e,this.captureTimeout=e.getCaptureTimeout(),this.captureRetries=e.getCaptureRetries(),this.captureSensibility=e.getCaptureSensibility(),this.divContainer=e.getContainer(),this.onExtractionFinish=e.getOnExtractionFinish(),this.onUserCancel=e.getOnUserCancel(),this.onExceptionCaptured=e.getOnExceptionCaptured(),this.onExtractionTimeout=e.getOnExtractionTimeout(),this.onModuleLoaded=e.getOnModuleLoaded(),this.onTrackStatus=e.getOnTrackStatus(),this.cameraReady=!1,this.contour=[!1,!1,!1,!1],this.cameraMustFlip=!1,this.cameraFrontSide=!1,this.mode=e.getMode(),this.status=FPhi.SelphID.Mode.Full,this.preview=e.getPreview(),this.qualityThreshold=e.getQualityThreshold(),this.edgeOffset=e.getEdgeOffset(),this.cropFactor=e.getCropFactor(),this.devicePixelRatio=window.devicePixelRatio,0==e.getCanvasHD()&&(this.devicePixelRatio=1),this.path=this.getScriptPath("FPhi.Widget.wasm.js"),console.log("FPhi.SelphID.Widget: Serving from URL: "+this.path),console.log("FPhi.SelphID.Widget: wasm path: "+this.path+"extractor/DocumentExtractor.wasm"),this.resourceParent=null,this.language=e.getLanguage(),this.fontSizeFactor=this.canvasHeight/500,this.fpsTime=performance.now(),this.baseURL=FPhi.SelphID.Widget.prototype.getScriptPath("FPhi.Widget.wasm.js")+"FPhi.Widget.Resources/",this.dpiList=e.getDpiList(),this.imageFormat=e.getImageFormat(),this.imageQuality=e.getImageQuality(),null!=document.getElementById("FPhi_Widget_rm_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_rm_script")),this.rmScript=document.createElement("script"),this.rmScript.id="FPhi_Widget_rm_script",this.rmReady=!1,this.rmScript.type="text/javascript",this.rmScript.src=this.path+"FPhi.Widget.rm.wasm.js",this.rmScript.onreadystatechange=this.OnResourceManagerLoaded.bind(this),this.rmScript.onload=this.OnResourceManagerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.rmScript),null!=document.getElementById("FPhi_Widget_graph_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_graph_script")),this.graphScript=document.createElement("script"),this.graphScript.id="FPhi_Widget_graph_script",this.graphReady=!1,this.graphScript.type="text/javascript",this.graphScript.src=this.path+"FPhi.Widget.graph.wasm.js",this.graphScript.onreadystatechange=this.OnGraphLoaded.bind(this),this.graphScript.onload=this.OnGraphLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.graphScript),null!=document.getElementById("FPhi_Widget_drawer_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_drawer_script")),this.drawerScript=document.createElement("script"),this.drawerScript.id="FPhi_Widget_drawer_script",this.drawerScript.type="text/javascript",this.drawerScript.src=this.path+"FPhi.Widget.drawer.wasm.js",this.drawerScript.onload=this.OnDrawerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.drawerScript),this.divContainer.addEventListener("FPhi.SelphID.Finish.event",this.onExtractionFinish,!0),this.divContainer.addEventListener("FPhi.SelphID.UserCancel.event",this.onUserCancel,!0),this.divContainer.addEventListener("FPhi.SelphID.ExtractionTimeout.event",this.onExtractionTimeout,!0),this.divContainer.addEventListener("FPhi.SelphID.ExceptionCaptured.event",this.onExceptionCaptured,!0),this.divContainer.addEventListener("FPhi.SelphID.ModuleLoaded.event",this.onModuleLoaded,!0),this.divContainer.addEventListener("FPhi.SelphID.TrackStatus.event",this.onTrackStatus,!0),this.worker=new Worker(this.path+"extractor/card.js"),this.onWorkerMessageContext=this.onWorkerMessage.bind(this),this.worker.onmessage=this.onWorkerMessageContext,this.workerWorking=!1,this.cameraContainer=document.createElement("div"),this.cameraContainer.id="cameraContainer",this.cameraContainer.style.overflow="hidden",this.cameraContainer.style.position="relative",this.cameraContainer.style.width=this.divContainer.offsetWidth+"px",this.cameraContainer.style.height=this.divContainer.offsetHeight+"px",this.divContainer.appendChild(this.cameraContainer),this.gifWait=document.createElement("img"),this.gifWait.style.display="none",this.gifWaitOnLoadContext=this.onWaitingLoaded.bind(this),this.gifWait.addEventListener("load",this.gifWaitOnLoadContext),this.gifWait.src=this.path+"FPhi.Widget.Resources/resources/163dpi/1_loading_selphID.gif",this.cropFactor<=0){var t=new CustomEvent("FPhi.SelphID.ExceptionCaptured.event",{detail:{message:"Invalid value of CropFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(t),this.cropFactor=1}if(this.resizeFactor<=0){t=new CustomEvent("FPhi.SelphID.ExceptionCaptured.event",{detail:{message:"Invalid value of ResizeFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(t),this.resizeFactor=1}this.sceneTimeout<=0&&(this.sceneTimeout=0)},FPhi.SelphID.Widget.checkAuth=function(){return new Promise((e,t)=>{fetch("https://ecertic.idcapture.es/auth").then(function(t){e(403!=t.status)})})},FPhi.SelphID.Widget.prototype={constructor:FPhi.SelphID.Widget,language:"es",privateCanvas:null,extractor:null,extractorLiveness:null,extractorVersion:"",lastDetectResult:null,lastExtractionResult:null,lastExtractionResultWizard:null,actualTime:0,actualTimePrev:0,idContainer:null,divContainer:null,extractorContainer:null,videoSelectId:null,cameraContainer:null,cameraWidth:null,cameraHeight:null,cameraRotation:0,canvasWidth:void 0,canvasHeight:void 0,cameraStream:null,selectedSource:null,samplePeriod:0,debug:!1,interactible:!0,globalTimeout:30,sceneTimeout:30,fps:0,fpse:0,fpsframes:0,fpseframes:0,fpsTime:null,fontSizeFactor:1,canvasSizeFactor:1,cameraList:new Array,graphPath:"graph.xml",Start:function(){document.featurePolicy&&0==document.featurePolicy.allowsFeature("camera")&&(console.log("SelphId: Feature Policy issue: Camera feature is restricted in the actual environment. Check your server HTTP Headers."),console.log("https://developers.google.com/web/updates/2018/06/feature-policy#js")),window.location!==window.parent.location&&console.log("SelphId widget running inside iframe."),this.selectedSource=null;var e=document.createElement("canvas");e.id="display",e.style="position:absolute; top:0px; left:0px; zIndex:1;",this.cameraContainer.appendChild(e),e.width=this.cameraContainer.offsetWidth*this.devicePixelRatio,e.height=this.cameraContainer.offsetHeight*this.devicePixelRatio,e.style.width=this.cameraContainer.offsetWidth+"px",e.style.height=this.cameraContainer.offsetHeight+"px",this.canvas=e,this.canvasRotated=document.createElement("canvas"),this.canvasRotated.width=e.height*this.devicePixelRatio,this.canvasRotated.height=e.width*this.devicePixelRatio,this.onCanvasResizeContext=this.onCanvasResize.bind(this),window.addEventListener("resize",this.onCanvasResizeContext,!1),this.initCamera(this.cameraContainer,this.cameraWidth,this.cameraHeight),this.setVideoInput(this),this.widgetTime=performance.now(),this.stateTime=this.widgetTime,this.cameraContainer.appendChild(this.gifWait)},Stop:function(){null!=this.worker&&(this.worker.terminate(),this.worker.onmessage=void 0,this.worker=null,this.onWorkerMessageContext=void 0),null!=this.divContainer&&(this.onCanvasResizeContext&&(window.removeEventListener("resize",this.onCanvasResizeContext,!1),this.onCanvasResizeContext=void 0),this.divContainer.removeEventListener("FPhi.SelphID.Finish.event",this.onExtractionFinish,!0),this.divContainer.removeEventListener("FPhi.SelphID.UserCancel.event",this.onUserCancel,!0),this.divContainer.removeEventListener("FPhi.SelphID.ExtractionTimeout.event",this.onExtractionTimeout,!0),this.divContainer.removeEventListener("FPhi.SelphID.ExceptionCaptured.event",this.onExceptionCaptured,!0),this.divContainer.removeEventListener("FPhi.SelphID.ModuleLoaded.event",this.onModuleLoaded,!0),this.divContainer.removeEventListener("FPhi.SelphID.TrackStatus.event",this.onTrackStatus,!0),this.divContainer.removeChild(this.cameraContainer),this.divContainer=null,this.cameraContainer=null),null!=this.cameraStream&&(this.cameraStream.getVideoTracks()[0].stop(),this.video.pause()),null!=this.rm&&(this.rm.caller=null,this.rm=null),null!=this.graph&&(this.graph=null),null!=this.drawer&&(this.drawer=null),null!=this.rmScript&&(this.rmScript.onreadystatechange=null,this.rmScript.onload=null,this.rmScript=null),null!=this.graphScript&&(this.graphScript.onreadystatechange=null,this.graphScript.onload=null,this.graphScript=null),null!=this.drawerScript&&(this.drawerScript.onload=null,this.drawerScript=null)},onWaitingLoaded:function(){var e=this.cameraContainer.offsetHeight/2-this.gifWait.height/2,t=this.cameraContainer.offsetWidth/2-this.gifWait.width/2;this.gifWait.style="position:absolute; top:"+e+"px; left:"+t+"px;"},onCanvasResize:function(){var e=this.canvas,t=e.getContext("2d",{alpha:!0}),i=this.video;this.cameraWidth=i.videoWidth,this.cameraHeight=i.videoHeight,0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=this.cameraWidth,this.privateCanvas.height=this.cameraHeight):(this.privateCanvas.width=this.cameraHeight,this.privateCanvas.height=this.cameraWidth),this.workerCanvas.width=this.cameraWidth,this.workerCanvas.height=this.cameraHeight,this.imagesProcessed=0,this.cameraContainer.style.width=this.divContainer.offsetWidth+"px",this.cameraContainer.style.height=this.divContainer.offsetHeight+"px",e.width=this.cameraContainer.offsetWidth*this.devicePixelRatio,e.height=this.cameraContainer.offsetHeight*this.devicePixelRatio,e.style.width=this.cameraContainer.offsetWidth+"px",e.style.height=this.cameraContainer.offsetHeight+"px",this.canvasRotated.width=e.height,this.canvasRotated.height=e.width,e.width<e.height&&this.cm.forceLandscape?(this.drawer.setCanvasSize(this.cameraContainer.offsetHeight,this.cameraContainer.offsetWidth),this.elements=this.rm.getElements(this.resourceParent,!0),this.updateExtractor(this.canvasRotated.getContext("2d",{alpha:!0}))):(this.drawer.setCanvasSize(this.cameraContainer.offsetWidth,this.cameraContainer.offsetHeight),this.elements=this.rm.getElements(this.resourceParent,this.drawer.landscape),this.updateExtractor(t)),this.startVideos(this),this.setCameraPosition(t,i)},onOrientationChange:function(){window.screen.orientation},GetAvailableCameras:function(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(this.gotDevices).catch(this.handleCameraError):(console.log("GetMediaDevices not available for this browser"),null)},onWorkerMessage:function(e){switch(this.workerWorking=!1,e.data.msg){case"bootedUp":var t=document.createElement("canvas");t.width=640,t.height=480;var i=t.getContext("2d").getImageData(0,0,640,480);this.worker.postMessage({msg:"init",output:i,qualityThreshold:this.qualityThreshold,edgeOffset:20}),this.workerWorking=!0;break;case"init":this.workerReady=!0,this.CheckDependencies(this);break;case"update":break;case"detected":if(this.contour=e.data.edges,this.imagesProcessed++,this.contour&&4==this.contour.length)for(var a=0;a<this.contour.length;a++)1==this.contour[a]&&0;if(e.data.output&&this.imagesProcessed>5){var s=this.canvas;this.canvas.width<this.canvas.height&&this.cm.forceLandscape&&(s=this.canvasRotated);var r=s.getContext("2d",{alpha:!0}),n=this.drawer.getDocRect(r,this.cameraWidth,this.cameraHeight,s.width/this.devicePixelRatio,s.height/this.devicePixelRatio,this.cameraMustFlip);if(this.canvas.width<this.canvas.height&&this.cm.forceLandscape){let e=this.drawer.getDocRectScreenSpace(r,r.canvas.width,r.canvas.height),t={x:r.canvas.height-(e.y+e.height),y:e.x,width:e.height,height:e.width};n=this.drawer.fromScreenToCamera(r,this.cameraWidth,this.cameraHeight,r.canvas.height,r.canvas.width,this.cameraMustFlip,t)}var h={x:n.x-(this.cropFactor-1)*n.width/2,y:n.y-(this.cropFactor-1)*n.height/2,width:n.width*this.cropFactor,height:n.height*this.cropFactor};h.x<0&&(h.width+=h.x,h.x=0),h.y<0&&(h.height+=h.y,h.y=0),h.x+h.width>=this.cameraWidth&&(h.width=this.cameraWidth-h.x),h.y+h.height>=this.cameraHeight&&(h.height=this.cameraHeight-h.y);var o=document.createElement("canvas");o.width=n.width,o.height=n.height,(r=o.getContext("2d")).drawImage(this.privateCanvas,n.x,n.y,n.width,n.height,0,0,n.width,n.height);var c=document.createElement("canvas");if(c.width=h.width,c.height=h.height,(r=c.getContext("2d")).drawImage(this.privateCanvas,h.x,h.y,h.width,h.height,0,0,h.width,h.height),this.canvas.width<this.canvas.height&&this.cm.forceLandscape){var d=document.createElement("canvas");d.width=n.height,d.height=n.width,(l=d.getContext("2d")).save(),l.translate(d.width/2,d.height/2),l.rotate(-Math.PI/2),l.drawImage(o,-d.height/2,-d.width/2),l.restore(),o=d;var l,m=document.createElement("canvas");m.width=h.height,m.height=h.width,(l=m.getContext("2d")).save(),l.translate(m.width/2,m.height/2),l.rotate(-Math.PI/2),l.drawImage(c,-m.height/2,-m.width/2),l.restore(),c=m}this.previewImage=o,0==this.imageCaptured?(this.imageCapturedTime=this.secondsWidget,this.privateImages.push(c)):this.privateImages[this.privateImages.length-1]=c,this.imageCaptured=!0,console.log("image captured at time "+this.secondsWidget)}}},setCameraPosition:function(e,t){var i=this.drawer.getCameraRect(e,this.cameraWidth,this.cameraHeight,this.cameraContainer.offsetWidth,this.cameraContainer.offsetHeight,this.resourceParent),a="0deg";1==this.cameraMustFlip&&(a="180deg"),i.visible?t.style="position:absolute; top:"+i.y+"px; left:"+i.x+"px; width:"+i.width+"px; height:"+i.height+"px; transform:rotateY("+a+"); zIndex:0;":t.style="position:absolute; top:-10000px; left:0px; width:"+i.width+"px; height:"+i.height+"px; transform:rotateY("+a+"); zIndex:0;"},OnGraphNewState:async function(e){this.stateTime=performance.now();var t=this.canvas;this.secondsWidget=(this.actualTime-this.widgetTime)/1e3,this.secondsState=(this.actualTime-this.stateTime)/1e3,this.state=e,this.resourceParent=this.drawer.getResourceIdForState(e);var i=this.video;(this.setCameraPosition(t.getContext("2d",{alpha:!0}),i),"UCNothing"==this.state||void 0===this.state)&&(this.actualTime=this.stateTime,this.widgetTime=this.stateTime,null!=(t=this.canvas)&&(t.style.display="inline-block"),this.video&&(this.video.style.display="inline-block"));if(this.debug&&console.log("state: "+e),null!=this.elements)for(var a=0;a<this.elements.length;a++)null!=this.elements[a].videoPlayer&&(this.elements[a].videoPlayer.pause(),this.elements[a].videoPlayer.removeAttribute("src"),this.elements[a].videoPlayer.removeEventListener("ended",this.videoplayerEnded.bind(s),!1),this.elements[a].videoPlayer.load(),this.elements[a].videoPlayer=null);if(this.elements=null,null!=this.resourceParent&&(this.canvas.width<this.canvas.height&&this.cm.forceLandscape?this.elements=this.rm.getElements(this.resourceParent,!0):this.elements=this.rm.getElements(this.resourceParent,this.drawer.landscape),this.startVideos(this)),"UCNothing"==e)switch(this.clockNewScenario=performance.now(),this.lastExtractionResult=null,this.privateImages=[],this.retries=0,this.mode){case FPhi.SelphID.Mode.Back:this.status=FPhi.SelphID.Mode.Back;break;default:this.status=FPhi.SelphID.Mode.Front}else if("UCCapture"==e)this.clockNewScenario=performance.now(),this.imagesProcessed=0,this.imageCaptured=!1,this.imageCapturedTime=0,this.previewImage=void 0,this.contour=[!1,!1,!1,!1],this.status==FPhi.SelphID.Mode.Back?this.privateImages.length=1:this.privateImages=[];else if("UCCaptureCameraSwitch"==e){var s=this;if(null!=this.cameraStream){let e=this.cameraStream.getVideoTracks()[0].getSettings().deviceId,t=await navigator.mediaDevices.enumerateDevices(),a=-1,r=-1;for(let i=0;i<t.length;i++)if(t[i].deviceId==e){a=i;break}for(let e=a+1;e<t.length;e++)if("videoinput"==t[e].kind){r=e;break}if(-1==r)for(let e=0;e<t.length;e++)if("videoinput"==t[e].kind){r=e;break}if(-1!=r&&r!=a){console.log("Camera switch success. New camera with id: "+t[r].deviceId),this.video.pause(),this.cameraStream.getVideoTracks()[0].stop(),this.cameraStream=null;let e=this.cm.getCameraWidth(),a=this.cm.getCameraHeight(),n={video:{deviceId:t[r].deviceId,width:e,height:a},audio:!1};navigator.mediaDevices.getUserMedia(n).then(function(e){let t=e.getVideoTracks()[0].getSettings();t&&("environment"==t.facingMode?s.cameraMustFlip=!1:s.cameraMustFlip=!0),s.cameraStream=e,s.cameraId=s.cameraStream.getVideoTracks()[0].getSettings().deviceId,i.srcObject=e,i.play(),s.setCameraPosition(s.canvas.getContext("2d",{alpha:!0}),s.video),s.graph.sendMessage("cameraSwitched")}).catch(function(e){console.log("Fatal error camera switch...",e)})}else console.log("Camera switch aborted. Only 1 available camera."),this.graph.sendMessage("cameraSwitched")}}else if("UCPreview"==e)this.clockNewScenario=performance.now();else if("UCPreviewDecision"==e)this.mode==FPhi.SelphID.Mode.Full&&this.status==FPhi.SelphID.Mode.Front?this.graph.sendMessage("Next"):this.graph.sendMessage("Finish");else if("UCFlip"==e)this.status=FPhi.SelphID.Mode.Back,this.retries=0;else if("UCCancelByUser"==e){this.clockNewScenario=performance.now();var r=new CustomEvent("FPhi.SelphID.UserCancel.event");this.divContainer.dispatchEvent(r),this.Stop()}else if("UCFinish"==e){var n=[];for(a=0;a<this.privateImages.length;a++)if(void 0!=this.privateImages[a]){var h=document.createElement("img");h.src=this.privateImages[a].toDataURL(this.imageFormat),n.push(h)}var o={images:n,cameraId:this.cameraId};r=new CustomEvent("FPhi.SelphID.Finish.event",{detail:o});this.divContainer.dispatchEvent(r),this.Stop()}else if("UCTimeout"==e)this.divContainer.dispatchEvent(new CustomEvent("FPhi.SelphID.ExtractionTimeout.event")),this.Stop();else if("UCErrors"==e){o={livenessMoveFails:this.livenessMoveActualFailedAttempts,livenessMoveHistory:this.livenessMoveHistory,livenessMoveStabilizedHistory:this.livenessMoveStabilizedStatusHistory,livenessMoveStabilizedStatus:this.livenessMoveLastStabilizedStatus};if(null!=this.lastExtractionResult&&null!=this.lastExtractionResult.sunGlassesScore&&(o.sunGlassesScore=this.lastExtractionResult.sunGlassesScore),this.logAllImages){for(n=[],a=0;a<this.privateImages.length;a++)void 0!=this.privateImages[a]&&n.push(this.getImgTag(this.privateImages[a],this.cropImage,this.cropFactor,this.imageFormat,this.imageQuality));o.images=n,o.timeStamp=this.privateLivenessResults}if(this.clockNewScenario=performance.now(),this.livenessDiagnostic<0)this.divContainer.dispatchEvent(new CustomEvent("FPhi.SelphID.ExtractionTimeout.event",{detail:o}));else{o.livenessErrorType=this.livenessDiagnostic;r=new CustomEvent("FPhi.SelphID.LivenessError.event",{detail:o});this.divContainer.dispatchEvent(r)}}if(null!=this.onTrackStatus&&this.divContainer){var c=new CustomEvent("FPhi.SelphID.TrackStatus.event",{detail:{code:FPhi.SelphID.TrackStatus.ChangeState,timeStamp:this.secondsWidget,data:e}});this.divContainer.dispatchEvent(c)}null!=this.graph&&this.graph.sendMessage("SetStatusFinished")},getImageData:function(e){var t=e.getContext("2d",{alpha:!0}),i=e.height,a=e.width;return{width:a,height:i,pixels:t.getImageData(0,0,a,i),time:performance.now()}},getImgTag:function(e,t,i,a,s){var r=document.createElement("canvas");r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e.pixels,0,0);var n=document.createElement("canvas");if(t&&void 0!=e.extractionResult&&void 0!=e.extractionResult.face){var h=e.extractionResult.face.width*i,o=e.extractionResult.face.height*i,c=e.extractionResult.face.x-(i-1)*e.extractionResult.face.width/2,d=e.extractionResult.face.y-(i-1)*e.extractionResult.face.height/2;c<0&&(h+=c,c=0),d<0&&(o+=d,d=0),c+h>=e.width&&(h=e.width-c),d+o>=e.height&&(o=e.height-d),n.width=h,n.height=o,n.getContext("2d").drawImage(r,c,d,h,o,0,0,n.width,n.height)}else n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(r,0,0,n.width,n.height);var l=document.createElement("img");return l.src=n.toDataURL(a,s),l},startVideos:function(e){if(null!=e.elements)for(var t=0;t<e.elements.length;t++)if("video"==e.elements[t].type){var i=document.createElement("video");i.hidden=!0,i.playsinline=!0,i.loop=!1,i.muted=!0,i.autoplay=!0,i.controls=!0,i.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId(e.resourceParent,e.elements[t].id,e.canvas.width<e.canvas.height,"value")),i.addEventListener("ended",e.videoplayerEnded.bind(e),!1),i.setAttribute("playsinline",""),i.setAttribute("webkit-playsinline",""),i.play(),e.elements[t].videoPlayer=i,console.log("start of video: "+e.elements[t].id,e.elements[t])}},canvasOnMove:function(e){if(void 0!=this.elements)for(var t=this.elements.length-1;t>=0;t--)if(void 0!=this.elements[t].layout&&e.offsetX>=this.elements[t].layout.x&&e.offsetX<this.elements[t].layout.x+this.elements[t].layout.width&&e.offsetY>=this.elements[t].layout.y&&e.offsetY<this.elements[t].layout.y+this.elements[t].layout.height){this.drawer.onMouseMove(e.target,this.elements[t].layout,this.resourceParent,this.elements[t].id,this.elements[t].type);break}},canvasOnClick:function(e){if("UCErrors"==this.state){var t;e.offsetX;if(e.offsetY>this.canvasHeight-this.buttonHeight)-1==this.livenessDiagnostic?(t=new CustomEvent("FPhi.SelphID.TimeoutErrorButtonClick.event"),this.divContainer.dispatchEvent(t)):(t=new CustomEvent("FPhi.SelphID.LivenessErrorButtonClick.event"),this.divContainer.dispatchEvent(t))}else{if(void 0==this.elements)return;let t=null;for(var i=this.elements.length-1;i>=0;i--){let a=e.offsetX,s=e.offsetY;if(this.canvas.width<this.canvas.height&&this.cm.forceLandscape&&(a=e.offsetY,s=this.canvas.width-e.offsetX),null!=this.elements[i].layout&&a>=this.elements[i].layout.x&&a<this.elements[i].layout.x+this.elements[i].layout.width&&s>=this.elements[i].layout.y&&s<this.elements[i].layout.y+this.elements[i].layout.height){t=this.elements[i].id;let e="Click//"+this.elements[i].id;this.graph.sendMessage(e);break}}if(null!=this.onTrackStatus&&this.divContainer){var a=new CustomEvent("FPhi.SelphID.TrackStatus.event",{detail:{code:FPhi.SelphID.TrackStatus.Tap,timeStamp:this.secondsWidget,data:t}});this.divContainer.dispatchEvent(a)}}},initCamera:function(e,t,i){var a=this.canvas;if(!this.video){let t=document.createElement("video");t.id="live",t.setAttribute("playsinline",""),t.setAttribute("webkit-playsinline",""),t.setAttribute("autoplay",""),t.setAttribute("muted",""),t.style.display="none",e.insertBefore(t,e.firstChild),this.video=t}a.imageSmoothingEnabled=!0,a&&(a.style.display="none",a.onclick=this.canvasOnClick.bind(this),a.addEventListener("mousemove",this.canvasOnMove.bind(this),!1),this.privateCanvas=document.createElement("canvas"),0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=t,this.privateCanvas.height=i):(this.privateCanvas.width=i,this.privateCanvas.height=t))},userMedia:function(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},setVideoInput:function(e){e.canvas&&e.playDevice(e,e.cm.getCameraId())},playDevice:async function(e,t){var i=this.video;this.canvas.getContext("2d",{alpha:!0});if(window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),null!=t){let a={video:{deviceId:t,width:e.cm.getCameraWidth(),height:e.cm.getCameraHeight()},audio:!1};navigator.mediaDevices.getUserMedia(a).then(function(t){let a=t.getVideoTracks()[0].getSettings();a&&("environment"==a.facingMode?e.cameraMustFlip=!1:e.cameraMustFlip=!0),e.cameraStream=t,e.cameraId=e.cameraStream.getVideoTracks()[0].getSettings().deviceId,i.srcObject=t,i.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),i.play()}).catch(function(t){console.log("Error open camera with id: "+e.cm.getCameraId()),console.log(t),e.playDevice(e,null)})}else{var a=e.cm.getCameraWidth(),s=e.cm.getCameraHeight(),r={video:{width:a,height:s,facingMode:{exact:1==e.cameraFrontSide?"user":"environment"}},audio:!1};e.cameraMustFlip=!0;navigator.mediaDevices.getUserMedia(r).then(function(t){var a=t.getVideoTracks()[0].getConstraints();a&&("environment"==a.facingMode.exact?e.cameraMustFlip=!1:e.cameraMustFlip=!0),e.cameraStream=t,e.cameraId=e.cameraStream.getVideoTracks()[0].getSettings().deviceId,i.srcObject=t,i.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),i.play()}).catch(function(t){var r={video:{width:a,height:s,facingMode:{exact:1!=e.cameraFrontSide?"user":"environment"}},audio:!1};e.cameraMustFlip=1!=e.cameraFrontSide;navigator.mediaDevices.getUserMedia(r).then(function(t){var a=t.getVideoTracks()[0].getConstraints();a&&("environment"==a.facingMode.exact?e.cameraMustFlip=!1:e.cameraMustFlip=!0),e.cameraStream=t,e.cameraId=e.cameraStream.getVideoTracks()[0].getSettings().deviceId,i.srcObject=t,i.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),i.play()}).catch(function(t){var r={video:{width:a,height:s,facingMode:"environment"},audio:!1};e.cameraMustFlip=!1;navigator.mediaDevices.getUserMedia(r).then(function(t){e.cameraMustFlip=!(e.mobileCheck()|e.isIpadOS()),e.cameraStream=t,e.cameraId=e.cameraStream.getVideoTracks()[0].getSettings().deviceId,i.srcObject=t,i.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),i.play()}).catch(function(t){console.log("Camera error",t);var i=new CustomEvent("FPhi.SelphID.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(i)})})})}},mobileCheck:function(){var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),t},isIpadOS:function(){return navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform)},gotDevices:function(e){var t=0;for(let i=0;i!==e.length;++i)"videoinput"===e[i].kind&&t++;this.cameraList=new Array(t);var i=0;for(let t=0;t!==e.length;++t){var a=e[t];if("videoinput"===a.kind){var s=document.createElement("option");s.value=a.deviceId,s.text=a.label,this.cameraList[i]=s,i++}}var r=new CustomEvent("FPhi.SelphID.Cameras.event",{detail:{cameras:this.cameraList}});this.divContainer.dispatchEvent(r)},handleCameraError:function(e){console.log("Camera GetUserMedia error: ",e)},getLayoutFromXML:function(e,t,i,a,s){let r="LEFT",n="TOP",h=i,o=!1;if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"width")){null==h&&(h={});var c=this.rm.getSetupFloat(e,t,this.drawer.landscape,"width");h.width=c<=1?c*a:c,o=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"height")){null==h&&(h={});var d=this.rm.getSetupFloat(e,t,this.drawer.landscape,"height");h.height=d<=1?d*s:d,o=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"xAnchor")&&(r=this.rm.getSetupAlign(e,t,this.drawer.landscape,"xAnchor")),this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"yAnchor")&&(n=this.rm.getSetupAlign(e,t,this.drawer.landscape,"yAnchor")),this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"x")){null==h&&(h={});var l=this.rm.getSetupFloat(e,t,this.drawer.landscape,"x");h.x=l<=1&&l>=-1?l*a:l,"CENTER"==r?h.x=a/2-h.width/2+h.x:"RIGHT"==r&&(h.x=a-h.width+h.x),o=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"y")){null==h&&(h={});var m=this.rm.getSetupFloat(e,t,this.drawer.landscape,"y");h.y=m<=1&&m>=-1?m*s:m,"CENTER"==n?h.y=s/2-h.height/2+h.y:"BOTTOM"==n&&(h.y=s-h.height+h.y),o=!0}return h},draw:function(e,t){if(null!=e.drawer){var i=e.canvas.getContext("2d",{alpha:!0});e.canvas.width<e.canvas.height&&e.cm.forceLandscape&&(i=e.canvasRotated.getContext("2d",{alpha:!0}));var a=i.canvas.width,s=i.canvas.height;i.clearRect(0,0,a,s),this.canvasWidth=a,this.canvasHeight=s,e.fpsframes++,e.actualTimePrev=e.actualTime,e.actualTime=performance.now();var r=(e.actualTime-e.fpsTime)/1e3;r>1&&(e.fps=e.fpsframes/r,e.fpseframes>0?e.fpse=e.fpseframes/r:e.fpse=0,e.fpsTime=e.actualTime,e.fpsframes=0,e.fpseframes=0);var n="Normal";if("UCCaptureStatus"==e.state&&0==e.imageCaptured&&(n="Warning"),e.iterateAutomata(e,t,i),e.secondsWidget=(e.actualTime-e.widgetTime)/1e3,e.secondsState=(e.actualTime-e.stateTime)/1e3,i.save(),i.scale(e.devicePixelRatio,e.devicePixelRatio),void 0!=e.elements){var h={progress:0};h.state=e.state,h.contour=e.contour,h.status=e.status,h.previewImage=e.previewImage,h.forceLandscape=e.cm.getForceLandscape();for(var o=0;o<e.elements.length;o++){if("button"!=e.elements[o].type&&"buttonImage"!=e.elements[o].type||0!=e.interactible)if(null!=(S=e.drawer.getLayout(i,e.resourceParent,e.elements[o].id,e.elements[o].type,e.secondsWidget,e.secondsState,n,h))&&(S=e.getLayoutFromXML(e.resourceParent,e.elements[o].id,S,a,s)),null!=S){e.elements[o].layout=S;var c=e.elements[o].mode,d=!1;if(null!=c){for(var l=c.split("|"),m=0;m<l.length;m++)if(l[m]==n){d=!0;break}}else d=!0;if(1==d){if("video"==e.elements[o].type)h.player=e.elements[o].videoPlayer;else if("camera"==e.elements[o].type){var g=e.privateCanvas.getContext("2d");switch(g.save(),e.cameraRotation){case 0:g.drawImage(t,0,0,e.cameraWidth,e.cameraHeight);break;case 1:g.translate(e.cameraHeight/2,e.cameraWidth/2),g.rotate(Math.PI/2*e.cameraRotation),g.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 2:g.translate(e.cameraWidth/2,e.cameraHeight/2),g.rotate(Math.PI/2*e.cameraRotation),g.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 3:g.translate(e.cameraHeight/2,e.cameraWidth/2),g.rotate(Math.PI/2*e.cameraRotation),g.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2)}switch(g.restore(),h.camera=e.privateCanvas,e.cameraRotation){case 0:case 2:h.width=e.cameraWidth,h.height=e.cameraHeight;break;default:h.width=e.cameraHeight,h.height=e.cameraWidth}h.cameraRotation=e.cameraRotation,h.cameraMustFlip=e.cameraMustFlip}e.drawer.draw(i,S,e.resourceParent,e.elements[o].id,e.elements[o].type,e.secondsWidget,e.secondsState,n,h)}}}}else if("UCErrors"==e.state){i.fillStyle="white",i.fillRect(0,0,a,s),text=e.livenessErrorString,fontHeight=15*e.fontSizeFactor;var u=e.rm.getSetupResourceId("facephi-widget-conf","","font_warning_message");i.font=fontHeight+"px '"+u+"'",i.fillStyle="black";for(var p=text.split("\n"),v=0;v<p.length;v++){var w=i.measureText(p[v]),f=330*e.canvasSizeFactor+fontHeight*v;i.fillText(p[v],a/2-w.width/2,f)}var C=e.livenessErrorImage,S=e.scaleRect({width:C.width,height:C.height},{x:.03*a,y:.378*s,width:.94*a,height:.1*s},!0);i.drawImage(C,S.x,S.y,S.width,S.height),e.drawButton(e,i,{x:0,y:s-e.buttonHeight,width:a,height:e.buttonHeight},"Results","button_finish"),e.secondsState}else"UCTimeout"==e.state&&(i.fillStyle="white",i.fillRect(0,0,a,s));if(e.debug){var x=4;if(i.fillStyle="#ff000044",i.fillRect(0,51,200,300),i.lineWidth=1,i.strokeStyle="#ff000088",i.strokeRect(0,51,200,300),i.font="14px Verdana",e.drawBorderedText(i,"Version"+e.extractorVersion,3,20*x,"black","white"),x++,e.drawBorderedText(i,"EdgeOffset: "+e.actualEdgeOffset,3,20*x,"black","white"),x++,e.drawBorderedText(i,"Mode: "+FPhi.SelphID.ModeStr[e.mode],3,20*x,"black","white"),x++,e.drawBorderedText(i,"Preview: "+e.preview,3,20*x,"black","white"),x++,e.drawBorderedText(i,"State: "+e.state,3,20*x,"black","white"),x++,e.drawBorderedText(i,"FPS: "+e.fps.toFixed(2),3,20*x,"black","white"),x++,e.drawBorderedText(i,"FPS Extractor: "+e.fpse.toFixed(2),3,20*x,"black","white"),x++,e.drawBorderedText(i,"Camera size: "+e.cameraWidth+"x"+e.cameraHeight+" px",3,20*x,"black","white"),x++,e.drawBorderedText(i,"Canvas size: "+a+"x"+s+" px",3,20*x,"black","white"),x++,e.drawBorderedText(i,"Camera rotation: "+e.cameraRotation,3,20*x,"black","white"),x++,e.drawBorderedText(i,"WidgetTime: "+e.secondsWidget.toFixed(2),3,20*x,"black","white"),x++,e.drawBorderedText(i,"StateTime: "+e.secondsState.toFixed(2),3,20*x,"black","white"),x++,e.drawBorderedText(i,"Operating mode: "+n,3,20*x,"black","white"),x++,e.drawBorderedText(i,"Capture Sensibility: "+FPhi.SelphID.CaptureSensibilityStr[e.captureSensibility],3,20*x,"black","white"),x++,e.docRect){let t=a/e.devicePixelRatio/4,s=t/e.docRect.width,r=e.docRect.height*s;i.drawImage(e.privateCanvas,e.docRect.x,e.docRect.y,e.docRect.width,e.docRect.height,a/e.devicePixelRatio-t-5,55,t,r)}}if(i.restore(),e.canvas.width<e.canvas.height&&e.cm.forceLandscape){var y=e.canvas.getContext("2d",{alpha:!0});y.clearRect(0,0,y.canvas.width,y.canvas.height),y.save(),y.translate(y.canvas.width/2,y.canvas.height/2),y.rotate(Math.PI/2),y.drawImage(e.canvasRotated,-y.canvas.height/2,-y.canvas.width/2),y.restore()}setTimeout(e.draw,e.samplePeriod,e,t)}},drawBorderedText:function(e,t,i,a,s,r){e.fillStyle=s,e.fillText(t,i,a),e.fillStyle=r,e.fillText(t,i-1,a-2)},openFullScreen:function(e){var t;e.requestFullscreen?t=e.requestFullscreen():e.mozRequestFullScreen?t=e.mozRequestFullScreen():e.webkitRequestFullscreen?t=e.webkitRequestFullscreen():e.msRequestFullscreen&&(t=e.msRequestFullscreen()),t.catch(function(e){})},iterateAutomata:function(e,t,i){if(0!=e.cameraReady)if("UCNothing"==e.state)e.graph.sendMessage("SetMode//0,0,0,"+(1==e.cm.getInitialTip()?"1":"0"));else if("UCCapture"==e.state){if(0==e.workerWorking)if(1==e.imageCaptured&&e.secondsWidget-e.imageCapturedTime>1||e.secondsState>e.captureTimeout&&e.captureTimeout>0)e.graph.sendMessage("CaptureFinish");else{var a=e.privateCanvas.getContext("2d");switch(a.save(),e.cameraRotation){case 0:a.drawImage(t,0,0,e.cameraWidth,e.cameraHeight);break;case 1:a.translate(e.cameraHeight/2,e.cameraWidth/2),a.rotate(Math.PI/2*e.cameraRotation),a.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 2:a.translate(e.cameraWidth/2,e.cameraHeight/2),a.rotate(Math.PI/2*e.cameraRotation),a.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 3:a.translate(e.cameraHeight/2,e.cameraWidth/2),a.rotate(Math.PI/2*e.cameraRotation),a.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2)}if(a.restore(),e.canvas.width<e.canvas.height&&e.cm.forceLandscape){let t=e.drawer.getDocRectScreenSpace(i,i.canvas.width,i.canvas.height),a={x:i.canvas.height-(t.y+t.height),y:t.x,width:t.height,height:t.width};e.docRect=e.drawer.fromScreenToCamera(i,e.cameraWidth,e.cameraHeight,i.canvas.height,i.canvas.width,e.cameraMustFlip,a)}else e.docRect=e.drawer.getDocRect(i,e.cameraWidth,e.cameraHeight,e.cameraContainer.offsetWidth,e.cameraContainer.offsetHeight,e.cameraMustFlip);var s=e.privateCanvas.getContext("2d").getImageData(e.docRect.x,e.docRect.y,e.docRect.width,e.docRect.height);e.worker.postMessage({msg:"detect",image:s,output:e.workerCanvasContext,width:e.docRect.width,height:e.docRect.height,roiWidth:e.docRect.width,roiHeight:e.docRect.height}),e.fpseframes++,e.workerWorking=!0}}else"UCCaptureStatus"==e.state?e.secondsState>1.5&&(1==this.imageCaptured?this.preview?this.graph.sendMessage("Preview"):this.mode==FPhi.SelphID.Mode.Full&&this.status==FPhi.SelphID.Mode.Front?this.graph.sendMessage("Next"):this.graph.sendMessage("Finish"):(this.retries++,this.retries>=this.captureRetries&&this.captureRetries>0&&0==this.debug?this.graph.sendMessage("Timeout"):this.graph.sendMessage("Fail"),this.updateExtractor(i))):"UCPreview"==e.state||"UCFlip"==e.state&&e.secondsState>1&&e.graph.sendMessage("Timer")},getVideoSources:function(e){navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e,t){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}):MediaStreamTrack.getSources(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e,t){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}),null==selectedSource&&console.log("selectedSource==null")},getScriptPath:function(e){var t,i=document.getElementsByTagName("script"),a=0;for(t=0;t<i.length;t++)i[t].src.indexOf(e)>-1&&(a=t);return i[a].src.split("/").slice(0,-1).join("/")+"/"},OnResourceManagerLoaded:function(e){this.rm=new FPhi.SelphID.ResourceManager(this.baseURL,this.language,this,this.OnResourceManagerStatus,this.dpiList,this.devicePixelRatio,1)},OnResourceManagerStatus:function(e,t){t&&(e.rmReady=!0,e.CheckDependencies(e))},OnGraphLoaded:function(e){this.graph=new FPhi.SelphID.Graph(this.path+this.graphPath,this.OnGraphReady.bind(this),this.OnGraphNewState.bind(this))},OnGraphReady:function(e){this.graphReady=!0,this.CheckDependencies(this)},OnDrawerLoaded:function(e){this.drawer=new FPhi.SelphID.Drawer(this.mode,this.preview,this.cm.getDocumentDimensions()),this.CheckDependencies(this)},CheckDependencies:async function(e){if(1==e.rmReady&&void 0!==e.drawer&&1==e.graphReady&&1==e.workerReady&&1==e.cameraReady&&"UCNothing"!=e.graph.state){var t=e.canvas;null!=t&&(t.style.display="none"),e.cameras=await navigator.mediaDevices.enumerateDevices(),e.cameraCount=0,console.log("SelphId: Camera enumeration");for(let t=0;t<e.cameras.length;t++)"videoinput"==e.cameras[t].kind&&(e.cameraCount++,console.log("SelphId: camera with id: "+e.cameras[t].deviceId));console.log("SelphId: "+e.cameraCount+" cameras found.");var i=new CustomEvent("FPhi.SelphID.ModuleLoaded.event",{detail:{cameraWidth:e.cameraWidth,cameraHeight:e.cameraHeight}});this.divContainer.dispatchEvent(i),e.drawer.rm=e.rm,e.drawer.cameraCount=e.cameraCount;let s=e.canvas;e.canvas.width<e.canvas.height&&e.cm.forceLandscape?(e.drawer.setCanvasSize(e.cameraContainer.offsetHeight,e.cameraContainer.offsetWidth),s=e.canvasRotated):e.drawer.setCanvasSize(e.cameraContainer.offsetWidth,e.cameraContainer.offsetHeight),e.graph.setInitialState("UCNothing");var a=s.getContext("2d",{alpha:!0});e.updateExtractor(a),e.draw(e,e.video),e.cameraContainer.removeChild(e.gifWait)}},updateExtractor:function(e){if(this.drawer){var t=this.drawer.getDocRect(e,this.cameraWidth,this.cameraHeight,e.canvas.width/this.devicePixelRatio,e.canvas.height/this.devicePixelRatio,this.cameraMustFlip),i=10*(1-1/.3*(t.width*t.height/(this.cameraWidth*this.cameraHeight)-.2))+20;i<20&&(i=20),i>30&&(i=30);let r=this.captureSensibility;switch(r==FPhi.SelphID.CaptureSensibility.Auto&&(r=(FPhi.SelphID.CaptureSensibility.Low+this.retries)%3),r){case FPhi.SelphID.CaptureSensibility.Low:i*=.8;break;case FPhi.SelphID.CaptureSensibility.High:i*=1.2}var a=document.createElement("canvas");a.width=640,a.height=480;var s=a.getContext("2d").getImageData(0,0,640,480);this.worker.postMessage({msg:"update",output:s,qualityThreshold:this.qualityThreshold,edgeOffset:i}),this.actualEdgeOffset=i}},videoLoaded:function(e){var t=!0;1==this.cameraReady&&(t=!1),console.log("videoLoaded event..."),this.cameraWidth=e.target.videoWidth,this.cameraHeight=e.target.videoHeight,0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=this.cameraWidth,this.privateCanvas.height=this.cameraHeight):(this.privateCanvas.width=this.cameraHeight,this.privateCanvas.height=this.cameraWidth),this.cameraReady=!0;this.video,this.canvas.getContext("2d",{alpha:!0});var i=document.createElement("canvas");i.width=this.cameraWidth,i.height=this.cameraHeight,this.workerCanvas=i,this.workerCanvasContext=i.getContext("2d").getImageData(0,0,this.cameraWidth,this.cameraHeight),t&&this.CheckDependencies(this)},videoFrame:function(e){this.canvasVideoPlayer.getContext("2d").drawImage(e.target,0,0)},videoplayerEnded:function(e){"UCWizardCompleted"==this.state?this.graph.sendMessage("VideoFinished"):e.target.play()}},void 0===FPhi.SelphID.ConfigurationManager){class ConfigurationManager{constructor(){this.container=null,this.language="en",this.dpiList=[163,326,489],this.cameraWidth=1280,this.cameraHeight=720,this.cameraId=null,this.onExtractionFinish=null,this.onUserCancel=null,this.onExceptionCaptured=null,this.onExtractionTimeout=null,this.onModuleLoaded=null,this.onTrackStatus=null,this.mode=FPhi.SelphID.Mode.Full,this.preview=!0,this.documentDimensions={x:0,y:0,width:85.6,height:53.98},this.qualityThreshold=60,this.edgeOffset=null,this.forceLandscape=!1,this.canvasHD=!1,this.cropFactor=1,this.initialTip=!1,this.captureTimeout=10,this.captureRetries=3,this.captureSensibility=FPhi.SelphID.CaptureSensibility.Auto,this.imageFormat="image/png",this.imageQuality=.92}setContainer(e){this.container=e}getContainer(){return this.container}setLanguage(e){this.language=e}getLanguage(){return this.language}setDpiList(e){this.dpiList=e}getDpiList(){return this.dpiList}setCameraWidth(e){this.cameraWidth=e}getCameraWidth(){return this.cameraWidth}setCameraHeight(e){this.cameraHeight=e}getCameraHeight(){return this.cameraHeight}setOnExtractionFinish(e){this.onExtractionFinish=e}getOnExtractionFinish(){return this.onExtractionFinish}setOnUserCancel(e){this.onUserCancel=e}getOnUserCancel(){return this.onUserCancel}setOnExceptionCaptured(e){this.onExceptionCaptured=e}getOnExceptionCaptured(){return this.onExceptionCaptured}setOnExtractionTimeout(e){this.onExtractionTimeout=e}getOnExtractionTimeout(){return this.onExtractionTimeout}setOnModuleLoaded(e){this.onModuleLoaded=e}getOnModuleLoaded(){return this.onModuleLoaded}setOnTrackStatus(e){this.onTrackStatus=e}getOnTrackStatus(){return this.onTrackStatus}setMode(e){this.mode=e}getMode(){return this.mode}setPreview(e){this.preview=e}getPreview(){return this.preview}setDocumentDimensions(e){this.documentDimensions=e}getDocumentDimensions(){return this.documentDimensions}setCropFactor(e){this.cropFactor=e,this.cropFactor<1&&(this.cropFactor=1)}getCropFactor(){return this.cropFactor}setQualityThreshold(e){this.qualityThreshold=e}getQualityThreshold(){return this.qualityThreshold}setEdgeOffset(e){this.edgeOffset=e}getEdgeOffset(){return this.edgeOffset}setForceLandscape(e){this.forceLandscape=e}getForceLandscape(){return this.forceLandscape}setCanvasHD(e){this.canvasHD=e}getCanvasHD(){return this.canvasHD}setCaptureTimeout(e){this.captureTimeout=e}getCaptureTimeout(){return this.captureTimeout}setCaptureRetries(e){this.captureRetries=e}getCaptureRetries(){return this.captureRetries}setCaptureSensibility(e){this.captureSensibility=e}getCaptureSensibility(){return this.captureSensibility}setImageFormat(e){this.imageFormat=e}getImageFormat(){return this.imageFormat}setImageQuality(e){this.imageQuality=e}getImageQuality(){return this.imageQuality}setCameraId(e){this.cameraId=e}getCameraId(){return this.cameraId}setInitialTip(e){this.initialTip=e}getInitialTip(){return this.initialTip}}FPhi.SelphID.ConfigurationManager=ConfigurationManager}